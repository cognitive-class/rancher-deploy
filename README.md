# Rancher Deploy

Simple Rancher deployment for DSWB.

## Prerequisites

* `dos2unix`
* `openssl`
* Docker v1.11.2
* Docker Compose v1.8.1
* Gumby cluster (`dswb-rancher`)

## Setup

1.  Save the TLS certificate bundle of your DSWB domain in `ssl/certificate-bundle.pem`.

1.  Save its signing key in `ssl/private-key.pem`.

1.  Create an `env` file using `env.example` as a reference.

    * `DSWB_DOMAIN` is your DSWB domain (e.g.: `dswb.example.com`).

    * `DHPARAM` can be generated by the following command. Mind that it will take several minutes to run.

      ```shell
      openssl dhparam -out ssl/dhparam.pem 4096
      ```

      Line breaks must be replaced with the literal `\n`, so that it can fit in one line. Use the following command, and copy/paste its output to `DHPARAM=<here>` in the `env` file.

      ```shell
      dos2unix ssl/dhparam.pem
      cat ssl/dhparam.pem | sed -e ':a' -e 'N' -e '$!ba' -e 's/\n/\\n/g'
      ```

    * `CERTIFICATE_BUNDLE` holds the TLS certificate bundle for the DSWB domain. Like for `DHPARAM`, line breaks must be replaced with the literal `\n`.

      ```shell
      dos2unix ssl/certificate-bundle.pem
      cat ssl/certificate-bundle.pem | sed -e ':a' -e 'N' -e '$!ba' -e 's/\n/\\n/g'
      ```

    * `PRIVATE_KEY` is the TLS certificate's signing key. One again, replace line breaks with the literal `\n`.

      ```shell
      dos2unix ssl/private-key.pem
      cat ssl/private-key.pem | sed -e ':a' -e 'N' -e '$!ba' -e 's/\n/\\n/g'
      ```

    * Set all password fields (`CATTLE_DB_CATTLE_PASSWORD`, `MYSQL_ROOT_PASSWORD`, and `MYSQL_PASSWORD`) to the same value. Use the command below to generate it.

      ```shell
      openssl rand -base64 16
      ```

1.  Reset permissions for the `env` file.

    ```shell
    chmod 400 env
    ```

## Deploy

1.  Change directory into Gumby's `dswb-rancher` cluster folder and source `.env`.

    ```shell
    cd .../dswb/gumby/clusters/dswb-rancher
    . .env
    ```

1.  Deploy Rancher using `docker-compose`.

    ```shell
    docker-compose -f .../dswb/rancher-deploy/docker-compose.yaml up -d
    ```

1.  Rancher will take several minutes to initialize. You can check its progress using the command below.

    ```shell
    docker-compose -f .../rancher-deploy/docker-compose.yaml logs -f rancher
    ```

    Hit `ctrl-c` at any time to exit.

After Rancher is initialized, you can access it at `https://<dswb-rancher private IP>`, or `https://rancher.DSWB_DOMAIN`, in case your DNS provider has already been configured.

## License

Please refer to [LICENSE](LICENSE).

## Authors

* Emerging Technologies Team, IBM Analytics Platform Services
* Henrique Zambon [@hzambon](https://twitter.com/hzambon)
